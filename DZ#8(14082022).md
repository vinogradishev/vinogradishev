### ДЗ №8 "Настройка PostgreSQL"
- Я создавал машину на YC, запустил там тесты и получил при настройках по дефолту 3-9 tps, что конкретно мало. Я поставил ВМ на старый хард, ему примерно 12 лет, выделил 2 ядра и 8 Гб оперативы. Вот тут было интересней. При 12 Гбайт свободного места, не удавалось сгенерировать БД более 6 Гбайт, тесты просто зибивали диск, и кластер не запускался. Я нашёл методом тыка настройки для подготовки(prepare) БД и начал тесты.
#### _1.Создал базу данных, 2 хранилища по 10 таблиц:_ 
##### sysbench --db-driver=pgsql --report-interval=2 --scale=2 --tables=10 --pgsql-host=127.0.0.1 --pgsql-port=5432 --pgsql-user=sbtest --pgsql-password=password --pgsql-db=sbtest /usr/share/sysbench/tpcc.lua prepare;
>> ![alt tag](https://github.com/vinogradishev/vinogradishev/blob/167640bfbf1e8ea3670b83094ab37f115a1bd9c6/createdb.png)

#### _2. 10 минут нагрузка утилитой SYSBENCH TPCC при дефолтных настройках кластера_ 
> Перед запуском теста сделал VACUUM, для него была работа. Запустил тест:
##### sysbench --db-driver=pgsql --report-interval=2 --scale=2 --tables=10 --time=600 --pgsql-host=127.0.0.1 --pgsql-port=5432 --pgsql-user=sbtest --pgsql-password=password --pgsql-db=sbtest /usr/share/sysbench/tpcc.lua run;
>> ![alt tag](https://github.com/vinogradishev/vinogradishev/blob/51b8f72a31a1c6d431360850721f3e8c0ad07cac/defaulttpcc.png)

#### _3. Настройка кластера. PGTune._
> Настройки кластера из PGTune, для OLTP системы:
>> ![alt tag](https://github.com/vinogradishev/vinogradishev/blob/51b8f72a31a1c6d431360850721f3e8c0ad07cac/clusterconf.png)

> Настроил AUTOVACUUM, чтобы он дольше спал, сделал штраф за долгое выполнение, выделил ему 2 процесса:
>> ![alt tag](https://github.com/vinogradishev/vinogradishev/blob/51b8f72a31a1c6d431360850721f3e8c0ad07cac/vacuumconf.png)

> Результат улучшился значительно: 29 tps против 210 tps. Настройки кластера наверное оптимальные, увеличивая, я не добивался прироста, а вот уменьшая, замечал падение производительности:
>> ![alt tag](https://github.com/vinogradishev/vinogradishev/blob/51b8f72a31a1c6d431360850721f3e8c0ad07cac/spectpcc.png)

#### _4. Асинхронный режим._
> Выключил синхронный коммит, время задержки создания контрольной точки 5 минут, результат стал ещё лучше, но при сбое кластер не восстанавливался, такое случилось два раза:
>> ![alt tag](https://github.com/vinogradishev/vinogradishev/blob/51b8f72a31a1c6d431360850721f3e8c0ad07cac/asynctpcc.png)

#### _5. Выводы._
> Настройки очень сильно влияют на производительность, нужен опыт применения разных систем для корректной настройки. Вот настройки которые очень сильно влияли на производительность: shared_buffers, work_mem, maintenance_work_mem, если их ставить меньше чем размер, например таблиц, то это очень снижает производительность. В моей системе всё упиралось в жёсткий диск, его скорости не хватало. Если включался VACUUM или wal_writer - это было сразу заметно по падению производительности.
